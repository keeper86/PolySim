services:
    caddy:
        image: caddy:alpine
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./Caddyfile.dev:/etc/caddy/Caddyfile
            - ./certs:/etc/caddy/certs
        environment:
            - CADDY_DOMAIN=${DEV_DOMAIN}
        depends_on:
            - app
        container_name: polysim-dev-caddy

    app:
        build:
            context: .
            dockerfile: Dockerfile.dev
        environment:
            DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@db:5432/${POSTGRES_DB:-app_dev}
        volumes:
            - ./src:/app/src
            - ./public:/app/public
            - ./package.json:/app/package.json
            - ./next.config.ts:/app/next.config.ts
        ports:
            - '3000:3000'
        depends_on:
            db:
                condition: service_healthy
            migrations:
                condition: service_completed_successfully
            keycloak:
                condition: service_healthy
        extra_hosts:
            - 'auth.polysim.local:${DEV_ONLY_DOCKER_HOST_IP}'
            - 'polysim.local:${DEV_ONLY_DOCKER_HOST_IP}'
        container_name: polysim-dev-app

    migrations:
        build:
            context: .
            dockerfile: Dockerfile.dev
        environment:
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
            NODE_ENV: development
        depends_on:
            db:
                condition: service_healthy
        restart: 'no'
        command: ['npx', 'knex', 'migrate:latest']
        container_name: polysim-dev-migrations

    db:
        image: postgres:15-alpine
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        ports:
            - '5432:5432'
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER}']
            interval: 10s
            timeout: 3s
            retries: 10
        container_name: polysim-dev-db

    keycloak:
        image: quay.io/keycloak/keycloak:26.3.4
        environment:
            KC_DB: dev-mem
            KC_BOOTSTRAP_ADMIN_USERNAME: admin
            KC_BOOTSTRAP_ADMIN_PASSWORD: admin
            KC_HOSTNAME: ${KEYCLOAK_DOMAIN}
            KC_HTTP_ENABLED: true
            KC_HEALTH_ENABLED: true
            KC_PROXY_HEADERS: xforwarded
            KC_RUN_IN_CONTAINER: true
        volumes:
            - ./keycloak/themes:/opt/keycloak/themes
            - ./keycloak/initial/data/dev:/opt/keycloak/data/import/
        command: start-dev --import-realm --verbose
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    "exec 3<>/dev/tcp/127.0.0.1/9000; echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost:9000\\r\\nConnection: close\\r\\n\\r\\n' >&3; cat <&3 | grep -q '\"status\": \"UP\"' && exit 0 || exit 1",
                ]
            interval: 10s
            timeout: 3s
            retries: 10
        container_name: polysim-dev-keycloak
