name: Website CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    checks:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
            - name: Cache npm
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-cache-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-cache-
            - name: Install dependencies
              run: npm ci
            - name: Check formatting
              run: npm run format:check
            - name: Lint
              run: npm run lint:check
            - name: Run unit tests
              run: npm run test

    e2e:
        runs-on: ubuntu-latest
        needs: checks
        if: (github.ref == 'refs/heads/main' || github.event.pull_request.base.ref == 'main')
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
            - name: Cache npm
              uses: actions/cache@v4
              with:
                  path: ~/.npm
                  key: ${{ runner.os }}-npm-cache-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-npm-cache-
            - name: Start services with Docker Compose
              run: |
                  docker compose -f docker-compose.development.yaml --env-file .env.development up --build -d
            - name: Wait for app to be ready
              run: npx wait-on --timeout=60000 https://polysim/api/health
            - name: Print container logs on failure
              if: failure()
              run: docker compose -f docker-compose.development.yaml --env-file .env.development logs && printenv
            - name: Run Playwright tests
              run: |
                  npx playwright install --with-deps
                  npm run test:e2e
            - name: Stop all containers
              if: always()
              run: docker compose -f docker-compose.development.yaml --env-file .env.development down
