name: Tracer CI

on:
    push:
        branches: [main]
        paths:
            - 'polysim_ctrace/**'
            - '.github/workflows/tracer-ci.yml'
        tags:
            - 'polysim-ctrace/v*'
    pull_request:
        branches: [main]
        paths:
            - 'polysim_ctrace/**'
            - '.github/workflows/tracer-ci.yml'

jobs:
    build-and-test:
        name: Build and test polysim_ctrace
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential cmake libssl-dev unzip strace

            - name: Cache CMake build artifacts
              uses: actions/cache@v4
              with:
                  path: |
                      polysim_ctrace/build
                      ~/.cache/cmake
                  key: ${{ runner.os }}-cmake-${{ hashFiles('polysim_ctrace/CMakeLists.txt', 'polysim_ctrace/VERSION') }}
                  restore-keys: |
                      ${{ runner.os }}-cmake-

            - name: Configure CMake
              working-directory: polysim_ctrace
              run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

            - name: Build
              working-directory: polysim_ctrace
              run: cmake --build build --config Release -- -j$(nproc)

            - name: Run tests
              working-directory: polysim_ctrace/build
              run: ctest --output-on-failure -j$(nproc)

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: polysim_ctrace-${{ github.sha }}
                  path: polysim_ctrace/build/polysim_ctrace
                  retention-days: 7

    package:
        name: Package and checksum
        runs-on: ubuntu-latest
        needs: build-and-test
        if: startsWith(github.ref, 'refs/tags/polysim-ctrace/v')
        permissions:
            contents: read
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential cmake libssl-dev

            - name: Get version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/polysim-ctrace/v}" >> $GITHUB_OUTPUT

            - name: Configure CMake
              working-directory: polysim_ctrace
              run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

            - name: Build
              working-directory: polysim_ctrace
              run: cmake --build build --config Release -- -j$(nproc)

            - name: Create release package
              working-directory: polysim_ctrace
              run: |
                  mkdir -p release
                  cp build/polysim_ctrace release/
                  cp README.md VERSION release/
                  # Copy LICENSE from repository root
                  cp ../LICENSE release/
                  tar -czf polysim_ctrace-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz -C release .

            - name: Generate checksums
              working-directory: polysim_ctrace
              run: |
                  sha256sum polysim_ctrace-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz > checksums.txt
                  sha256sum build/polysim_ctrace >> checksums.txt

            - name: Upload release artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: release-assets
                  path: |
                      polysim_ctrace/polysim_ctrace-*.tar.gz
                      polysim_ctrace/checksums.txt
                  retention-days: 30

    release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: package
        if: startsWith(github.ref, 'refs/tags/polysim-ctrace/v')
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Get version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/polysim-ctrace/v}" >> $GITHUB_OUTPUT

            - name: Download release artifacts
              uses: actions/download-artifact@v4
              with:
                  name: release-assets
                  path: release-assets

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: polysim_ctrace v${{ steps.version.outputs.VERSION }}
                  body: |
                      Release of polysim_ctrace version ${{ steps.version.outputs.VERSION }}

                      ## Installation

                      Download the appropriate package for your platform and extract:
                      ```bash
                      tar -xzf polysim_ctrace-${{ steps.version.outputs.VERSION }}-linux-x86_64.tar.gz
                      ```

                      ## Checksums

                      See `checksums.txt` for SHA256 checksums of all release artifacts.
                  files: |
                      release-assets/polysim_ctrace-*.tar.gz
                      release-assets/checksums.txt
                  draft: false
                  prerelease: false

    docker-build:
        name: Build Docker image
        runs-on: ubuntu-latest
        needs: build-and-test
        if: startsWith(github.ref, 'refs/tags/polysim-ctrace/v')
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v5

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Get version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF#refs/tags/polysim-ctrace/v}" >> $GITHUB_OUTPUT

            - name: Extract metadata
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ghcr.io/${{ github.repository }}/polysim_ctrace
                  tags: |
                      type=semver,pattern={{version}},value=${{ steps.version.outputs.VERSION }}
                      type=semver,pattern={{major}}.{{minor}},value=${{ steps.version.outputs.VERSION }}
                      type=semver,pattern={{major}},value=${{ steps.version.outputs.VERSION }}
                      type=raw,value=latest

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: polysim_ctrace
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Logout from GitHub Container Registry
              run: docker logout ghcr.io
